import os
from openai import OpenAI

# 本地 LLaMA-Factory API
BASE_URL = "http://127.0.0.1:8000/v1"
MODEL = "gpt-3.5-turbo"  # 若启动时设置了 API_MODEL_NAME，请改成对应名字
API_KEY = "EMPTY"
os.environ["OPENAI_API_KEY"] = API_KEY

def main():

    system = "\nYou are a professional health assistant. Please provide evidence-based, safe health advice to users. \nAlways prioritize patient safety and recommend immediate medical attention for emergencies. \n\n**IMPORTANT:** Keep your entire response concise—**the total number of characters (including spaces) must not exceed 2000**. \nIf the answer would be longer, please use brief sentences.\n"

    prompt = """
请你通读【病历信息】后，综合该患儿的发病及诊疗过程，回答以下问题：

1、给出该患儿最可能的初步诊断及其诊断依据。

2、进行鉴别诊断。

【病历信息】

性别：男，年龄：15岁，主因"咳嗽2月，呼吸困难15天"于2025-05-01 22:07入病房。

现病史：入院前2月出现咳嗽，病初呈阵发性单声咳嗽，后逐渐加重，夜间为著，近15天时候呼吸困难、夜间睡眠时憋醒，近期上楼费力、爬至4楼时心率增快。病程中无发热，无胸痛，偶有胸闷，夜间偶有喘促，食欲减少，尿便正常。于家中自行口服头孢类药物3-4天，未见好转，为求进一步诊治故来我院，急诊以"重症肺炎、心包积液"收治入院。

既往病史：患儿3年前左脸行血管瘤介入术，现间断介入治疗中。

入院时查体：体温：36.7 ℃，脉搏：98 次/分，呼吸：20 次/分，血压:124/68mmHg，体重：70kg。

神志清楚，精神萎靡，呼吸尚平稳，口唇发绀，周身未见皮疹及出血点咽部充血，右肺呼吸音较弱、肺底可闻及细密湿啰音，心音有力，心率 98次/分，节律规整，腹部平坦、柔软，无固定压痛，无肌紧张及反跳痛，肝脾肋下未触及，肠鸣音4次/分，四肢末梢温暖，活动自如，神经系统查体未见阳性体征。

辅助检查：

2025-05-01肺部CT：右肺感染性病变，右侧心缘旁至右肺下叶背段软组织密度影，心包腔积液。

入我科室时血气分析：PH:7.41 ，PO2：78 mmHg，PaCO2：39 mmHg，BE: 0.1 mmol/L，SO2：96 %，K﹢:3.5 mmol/L，Na﹢: 142 mmol/L，Ca2﹢: 0.81 mmol/L，THbc: 14.0 ，Glu: 5.9 mmol/L，Lac: 0.7 mmol/L。

B型钠尿肽前体（PRO-BNP）测定（2025-05-01 23:24） ：N端前B型钠尿肽测定:60pg/mL

降钙素原检测^血常规+C反应蛋白+血清淀粉样蛋白A（SAA）（2025-05-01 23:52） ：
★白细胞计数:6.00×10⁹/L，中性粒细胞百分比:63.84%，淋巴细胞百分比:25.54%，单核细胞百分比:7.24%，
中性粒细胞绝对值:3.83×10⁹/L，★红细胞计数:4.77×10¹²/L，★血红蛋白:138g/L，★红细胞比容:42.10%，
★血小板计数:258×10⁹/L，C反应蛋白:12.62mg/L↑，血清淀粉样蛋白A:9.43mg/L，降钙素原:0.1ng/mL；

肺炎支原体血清学试验（凝聚法）（2025-05-02 01:07） ：肺炎支原体抗体:阴性。

心电图：窦性心动过速104-110bpm，心电轴正常，不正常心电图，可疑心频图缺血。

心脏三维+左心功能测定+组织超声(江南)(2025-05-02 09:24 ) :卵圆孔未闭心包积液(少-中量)左室张功能欠佳建议随诊复查。

肺炎支原体血清学试验（凝聚法）（2025-05-02 01:07） ：肺炎支原体抗体:阴性；

凝血六项（2025-05-02 09:18） ：*凝血酶原时间:13.50sec，凝血酶原百分率:66.90%，纤维蛋白原时间:4.70sec，*纤维蛋白原含量:4.58g/L，D-二聚体:0.92mg/L FEU。

钙、镁、磷测定^离子三项^心肌酶^肾功测定^肝功1测定（2025-05-02 10:27） ：★天门冬氨酸氨基转移酶:10U/L，★总蛋白:56.52g/L，★白蛋白:37.27g/L，前白蛋白:136.40mg/L，★肌酸激酶:42U/L，缺血性修饰白蛋白:78.30U/mL，★钙:2.00mmol/L；

心肌标志物系列（2025-05-02 10:46） ：肌红蛋白:16.78ng/ml；

癌胚抗原测定(CEA)(化学发光法全自动发光仪)^甲胎蛋白测定(AFP)(化学发光法全自动发光仪)（2025-05-02 10:46） ：正常；

免疫球蛋白测定^抗链球菌O测定（ASO）（免疫法散射比浊法）（2025-05-02 10:50） ：免疫球蛋白L轻链:0.886g/L；

呼吸道病原体核酸检测（八项）（2025-05-02 12:36） ：均阴性。

EB病毒抗体谱（六项）（2025-05-02 13:25） ：EB病毒衣壳抗原IgG:可疑，EB病毒核抗原IgG:阳性；

总IgE测定(酶法)（2025-05-02 14:26） ：总IgE:4.60 TIgEIU/ml；

ABO+RH血型鉴定（2025-05-02 14:30） ：ABO血型（微柱法）:A，RH血型（微柱法）:+；

风湿系列（2025-05-02 14:32） ：类风湿因子:<8.75IU/ml，抗链球菌溶血素"O":<50.3IU/ml；

甲状腺功能测定(五项)（2025-05-02 14:33） ：正常；

血浆凝血因子Ⅱ、Ⅶ、Ⅷ、Ⅸ、Ⅹ活性测定（仪器法）（2025-05-02 14:58） ：凝血因子Ⅶ:52.00%，凝血因子Ⅹ:65.20%；

梅毒螺旋体特异抗体测定(化学发光法全自动发光仪)^乙肝五项^人免疫缺陷病毒抗体测定(Anti-HIV)(化学发光法全自动发光仪)^丙型肝炎抗体测定(Anti-HCV)(化学发光法全自动发光仪)（2025-05-02 15:22） ：★乙肝肝炎病毒表面抗体:169.87mIU/mL；

尿沉渣定量(流式细胞仪法)^尿液分析（2025-05-02 15:35） ：★尿比重:1.010，小圆上皮细胞:3.3个/μL；

1-3-β-D葡聚糖检测+细菌内毒素检测（2025-05-05 13:26） ：1-3-β-D葡聚糖检测:<10.00pg/mL，细菌内毒素测定:<5.00pg/mL；

感染病原宏基因组学检测报告：（痰液）：人疱疹病毒7型（病毒阳性）序列数4，肺炎克雷伯菌（细菌疑似）序列数12，黄曲霉（真菌疑似）序列数1。结核感染T细胞检测(T-SPOT法)：结核感染T细胞检测:阴性。

心脏三维+左心功能测定+组织超声(2025-05-02 09:24 ) :卵圆孔未闭心包积液(少-中量)左室张功能欠佳建议随诊复查

腹部+胃肠道彩色多普勒超声检查(2025-05-02 08:41 ) :目前肝、脾、胰腺结构未见明显异常目前未见急腹症征象

电子支气管镜检查：镜下诊断：主支气管下1/3处至右主支气管可见密集白色结节样突起，右肺上叶、中下叶开口明显狭窄。
"""

    print("User prompt:\n")
    print(prompt)
    print("\nAnswer:\n")

    client = OpenAI(base_url=BASE_URL, api_key=API_KEY)
    try:
        resp = client.chat.completions.create(
            model=MODEL,
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": prompt},
            ],
            temperature=0.0,
            max_tokens=2048,
        )
        print(resp.choices[0].message.content.strip())
    except Exception as e:
        print(f"Error during generation: {e}")

if __name__ == "__main__":
    main()

# python /aaa/gelseywang/buddy1/lukatang/LLMs/BFT_github/Hunyuan-BFT/api_hunyuan_a13b_health.py